  {
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
      "globalLocation": {
        "type": "string",
        "defaultValue": "eastus",
        "allowedValues": ["eastus","eastus2","westus","westus2","centralus","westeurope","northeurope","southeastasia","uksouth","japaneast","southindia","centralindia"],
        "metadata": { "description": "Default location for general resources" }
      },
      "resourcePrefix": {
        "type": "string",
        "metadata": { "description": "Prefix for resource names (e.g., myproj)" }
      },
      "storageAccountSku": {
        "type": "string",
        "defaultValue": "Standard_LRS",
        "allowedValues": ["Standard_LRS","Standard_GRS","Standard_RAGRS","Standard_ZRS","Premium_LRS"]
      },
      "storageContainerName": { "type": "string", "defaultValue": "appcontainer" },
      "cosmosDbAccountName": 
      { "type": "string", 
      "metadata": 
      { "description": "Globally unique Cosmos DB account name" } 
    },
      "cosmosDbConsistencyLevel": { "type": "string", "defaultValue": "Session", "allowedValues": ["Strong","BoundedStaleness","Session","ConsistentPrefix","Eventual"] },
      "postgresqlServerName": { "type": "string" },
      "postgresqlAdminUser": { "type": "string" },
      "postgresqlAdminPassword": { "type": "secureString" },
      "postgresqlSkuName": { "type": "string", "defaultValue": "Standard_D2s_v3", "allowedValues": ["Standard_B1ms","Standard_B2s","Standard_D2s_v3","Standard_D4s_v3","Standard_E2s_v3"] },
      "searchServiceName": { "type": "string" },
      "searchSku": { "type": "string", "defaultValue": "standard", "allowedValues": ["basic","standard","standard2","standard3","storage_optimized_l1","storage_optimized_l2"] },
      "translatorAccountName": { "type": "string" },
      "translatorTier": { "type": "string", "defaultValue": "S0", "allowedValues": ["F0","S0","S1","S2"] },
      "translatorRegion": { "type": "string", "defaultValue": "eastus", "allowedValues": ["eastus","eastus2","westeurope","northcentralus","southindia","uksouth","southeastasia"] },
      "speechAccountName": { "type": "string" },
      "speechRegion": { "type": "string", "defaultValue": "eastus", "allowedValues": ["eastus","eastus2","westeurope","uksouth","southeastasia","southindia"] },
      "accountName": { "type": "string", "defaultValue": "pitstopnewai", "metadata": { "description": "Name of the Cognitive Services account" } },
      "OpenaiRegion": { "type": "string", "defaultValue": "eastus", "allowedValues": ["eastus","eastus2","westus","westus2","centralus","northeurope","westeurope","southeastasia","japaneast"] },
      "skuName": { "type": "string", "defaultValue": "S0", "allowedValues": ["F0","S0"], "metadata": { "description": "Select the SKU: Free (F0) or Standard (S0)" } },
      "functionAppName": { "type": "string" },
      "appServicePlanName": { "type": "string", "defaultValue": "func-app-plan" },
      "containerRegistryName": { "type": "string" },
      "containerRegistrySku": { "type": "string", "defaultValue": "Basic", "allowedValues": ["Basic","Standard","Premium"] }
    },
    "variables": {
      "storageAccountName": "[toLower(concat(parameters('resourcePrefix'),'st',uniqueString(resourceGroup().id)))]",
      "appInsightsName": "[concat(parameters('resourcePrefix'),'-appi')]",
      "appServicePlanId": "[resourceId('Microsoft.Web/serverfarms', parameters('appServicePlanName'))]",
      "openAiDeploymentName": "gpt4-1-mini-deployment"
    },
    "resources": [
      {
        "type": "Microsoft.ContainerRegistry/registries",
        "apiVersion": "2023-01-01-preview",
        "name": "[parameters('containerRegistryName')]",
        "location": "[parameters('globalLocation')]",
        "sku": { "name": "[parameters('containerRegistrySku')]" },
        "properties": { "adminUserEnabled": true }
      },
      {
        "type": "Microsoft.Storage/storageAccounts",
        "apiVersion": "2022-09-01",
        "name": "[variables('storageAccountName')]",
        "location": "[parameters('globalLocation')]",
        "kind": "StorageV2",
        "sku": { "name": "[parameters('storageAccountSku')]" }
      },
      {
        "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
        "apiVersion": "2022-09-01",
        "name": "[concat(variables('storageAccountName'),'/default/',parameters('storageContainerName'))]",
        "dependsOn": ["[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]"],
        "properties": { "publicAccess": "None" }
      },
      {
        "type": "Microsoft.DocumentDB/databaseAccounts",
        "apiVersion": "2021-04-15",
        "name": "[parameters('cosmosDbAccountName')]",
        "location": "[parameters('globalLocation')]",
        "kind": "GlobalDocumentDB",
        "properties": {
          "databaseAccountOfferType": "Standard",
          "consistencyPolicy": { "defaultConsistencyLevel": "[parameters('cosmosDbConsistencyLevel')]" },
          "locations": [{ "locationName": "[parameters('globalLocation')]" }]
        }
      },
      {
        "type": "Microsoft.DBforPostgreSQL/flexibleServers",
        "apiVersion": "2021-06-01",
        "name": "[parameters('postgresqlServerName')]",
        "location": "[parameters('globalLocation')]",
        "properties": {
          "administratorLogin": "[parameters('postgresqlAdminUser')]",
          "administratorLoginPassword": "[parameters('postgresqlAdminPassword')]",
          "version": "13",
          "storage": { "storageSizeGb": 32 }
        },
        "sku": {
          "name": "[parameters('postgresqlSkuName')]",
          "tier": "GeneralPurpose",
          "family": "Gen5",
          "capacity": 2
        }
      },
      {
        "type": "Microsoft.Search/searchServices",
        "apiVersion": "2020-08-01",
        "name": "[parameters('searchServiceName')]",
        "location": "[parameters('globalLocation')]",
        "sku": { "name": "[parameters('searchSku')]" },
        "properties": { "replicaCount": 1, "partitionCount": 1 }
      },
      {
        "type": "Microsoft.CognitiveServices/accounts",
        "apiVersion": "2025-06-01",
        "name": "[parameters('translatorAccountName')]",
        "location": "[parameters('translatorRegion')]",
        "sku": { "name": "[parameters('translatorTier')]" },
        "kind": "TextTranslation"
      },
      {
        "type": "Microsoft.CognitiveServices/accounts",
        "apiVersion": "2025-06-01",
        "name": "[parameters('speechAccountName')]",
        "location": "[parameters('speechRegion')]",
        "sku": { "name": "S0" },
        "kind": "SpeechServices"
      },
      {
        "type": "Microsoft.CognitiveServices/accounts",
        "apiVersion": "2025-06-01",
        "name": "[parameters('accountName')]",
        "location": "[parameters('OpenaiRegion')]",
        "sku": { "name": "[parameters('skuName')]" },
        "kind": "AIServices",
        "identity": { "type": "SystemAssigned" },
        "properties": { "customSubDomainName": "[parameters('accountName')]", "publicNetworkAccess": "Enabled" }
      },
      {
        "type": "Microsoft.CognitiveServices/accounts/deployments",
        "apiVersion": "2025-06-01",
        "name": "[concat(parameters('accountName'),'/gpt-4.1-mini')]",
        "dependsOn": ["[resourceId('Microsoft.CognitiveServices/accounts', parameters('accountName'))]"],
        "sku": { "name": "GlobalStandard", "capacity": 1 },
        "properties": {
          "model": { "format": "OpenAI", "name": "gpt-4.1-mini", "version": "2025-04-14" },
          "versionUpgradeOption": "OnceNewDefaultVersionAvailable",
          "currentCapacity": 1
        }
      },
      {
        "type": "Microsoft.Web/serverfarms",
        "apiVersion": "2021-02-01",
        "name": "[parameters('appServicePlanName')]",
        "location": "[parameters('globalLocation')]",
        "sku": { "name": "Y1", "tier": "Dynamic", "size": "Y1", "capacity": 0 }
      },
      {
        "type": "Microsoft.Insights/components",
        "apiVersion": "2015-05-01",
        "name": "[variables('appInsightsName')]",
        "location": "[parameters('globalLocation')]",
        "properties": { "Application_Type": "web" }
      },
      {
        "type": "Microsoft.Web/sites",
        "apiVersion": "2021-02-01",
        "name": "[parameters('functionAppName')]",
        "location": "[parameters('globalLocation')]",
        "kind": "functionapp",
        "dependsOn": [
          "[resourceId('Microsoft.Web/serverfarms', parameters('appServicePlanName'))]",
          "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]",
          "[resourceId('Microsoft.Insights/components', variables('appInsightsName'))]"
        ],
        "properties": {
          "serverFarmId": "[variables('appServicePlanId')]",
          "siteConfig": {
            "appSettings": [
              { "name": "AzureWebJobsStorage", "value": "[concat('DefaultEndpointsProtocol=https;AccountName=', variables('storageAccountName'), ';AccountKey=', listKeys(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')), '2022-09-01').keys[0].value, ';EndpointSuffix=core.windows.net')]" },
              { "name": "FUNCTIONS_EXTENSION_VERSION", "value": "~4" },
              { "name": "WEBSITE_RUN_FROM_PACKAGE", "value": "1" },
              { "name": "APPINSIGHTS_INSTRUMENTATIONKEY", "value": "[reference(resourceId('Microsoft.Insights/components', variables('appInsightsName')), '2015-05-01').InstrumentationKey]" }
            ]
          }
        }
      }
    ],
    "outputs": {
      "openAiEndpoint": {
        "type": "string",
        "value": "[reference(resourceId('Microsoft.CognitiveServices/accounts', parameters('accountName')), '2025-06-01').properties.endpoint]"
      },
      "openAiKey": {
        "type": "string",
        "value": "[listKeys(resourceId('Microsoft.CognitiveServices/accounts', parameters('accountName')), '2025-06-01').key1]"
      }
    }
  }
